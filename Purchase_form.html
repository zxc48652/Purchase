<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¡è³¼è¡¨å–®</title>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(to bottom right, #eef3f9, #dde6f1);
      color: #2c3e50;
    }
    .container { display: flex; gap: 20px; padding-top: 20px; }
    .sidebar {
      width: 180px;
      background: linear-gradient(to bottom left, #1d3557, #2a9d8f);
      color: #fff;
      padding: 20px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      border-radius: 12px;
      margin-left: 20px;
    }
    .sidebar button {
      width: 160px;
      height: 48px;
      margin-bottom: 15px;
      font-size: 16px;
      border-radius: 10px;
      background-color: #1abc9c;
      color: white;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 8px rgb(0, 0, 0,0.1); /*åŠ é™°å½±*/
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .sidebar button:hover {
      background-color: #16a085; /* æ·±ä¸€é»çš„ç¶ è‰² */
      transform: translateY(-2px); /* âœ… å‘ä¸Šæµ®èµ· */
    }
    #printButton {
      background-color: white;
      color: #2c3e50;
      border: 2px solid #2c3e50;
      font-weight: bold;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    #printButton:hover {
      background-color: #f2f2f2;
      transform: translateY(-2px);
    }
    .main {
      flex: 1;
      padding: 0 30px 30px 30px;
      background-color: #f7f9fb;
    }
    .section {
      background: #fff;
      padding: 24px;
      margin-bottom: 40px;
      border-radius: 12px;
      border-left: 6px solid #3498db;
    }
    .form-header {
      background: linear-gradient(to left, #1d3557, #2a9d8f);
      color: white;
      padding: 20px;
      border-radius: 12px 12px 0 0;
      text-align: center;
    }
    .form-header h2 { margin: 0; font-size: 24px; font-weight: bold; color: #90f7ec; }
    .form-header p { margin-top: 6px; font-size: 14px; color: #d0e7e5; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    table th, table td {
      border: 1px solid #dce3e8;
      padding: 8px;
      text-align: center;
    }
    table th { background-color: #eaf3fb; font-weight: 600; }
    input { width: 100%; padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
    input[type="date"] { text-align: center; }
    .submit-btn {
      background-color: #2ecc71;
      color: #fff;
      border: none;
      padding: 14px 24px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .submit-btn:hover {
      background-color: #27ae60; /* æ·±ä¸€é»çš„ç¶ è‰² */
      transform: translateY(-2px); /* ç¨å¾®æµ®èµ· */
    }
    button {
      padding: 4px 10px;
      border-radius: 6px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    button[type="button"] {
      background-color: #3498db;
      color: white;
    }
    button[type="button"]:hover {
      background-color: #2980b9;
    }
    .delete-btn {
      background-color: #e74c3c !important;
      color: white;
    }
    .delete-btn {
      background-color: #c0392b !important;
    }
    .add-btn {
      margin-top: 16px;
      background-color: #3498db;
      color: white;
      font-weight: bold;
      padding: 6px 14px;
      border-radius: 8px;
    }
    .spinner {
      width: 32px;
      height: 32px;
      border: 4px solid #ddd;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    .spinner-small {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid white;
      border-top: 2px solid #2ecc71;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
   select {
    width: 100%;
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
    box-sizing: border-box;
    background-color: #fff;
   }
  .table-sent-success {
    background-color: #e0f7e9 !important;
    transition: background-color 0.3s ease;
  }
  .input-wrapper {
    position: relative;
  }
  .input-wrapper input {
    padding-left: 18px;
    text-align: right;
  }
  .input-wrapper::before {
    content: "$";
    position: absolute;
    left: 6px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
    color: #555;
  }
  input[name="qty"],input[name="price"] {
    text-align: center;
  }
  .sidebar button.active {
    background-color: #0e766e !important;
    transform: scale(1.05);
  }
  </style>
</head>
<body>
  <div id="loadingOverlay" style="
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(255, 255, 255, 0.9);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    color: #3498db;
    font-family: 'Segoe UI', sans-serif;
    ">
    <div class="spinner" style="margin-bottom: 10px;"></div>
    è³‡æ–™è¼‰å…¥ä¸­...
  </div>
  <div class="form-header">
    <h2>ç‘é‘«é›»å­ç§‘æŠ€æœ‰é™å…¬å¸</h2>
    <p>ğŸ“‹ æ¡è³¼è¡¨å–®</p>
  </div>
  <div class="container">
    <div class="sidebar">
      <button onclick="resetForm()">ğŸ”„ é‡æ–°æ•´ç†</button>
      <button id="printButton" onclick="printPurchaseOrder()">ğŸ–¨ï¸ åˆ—å°</button>
      <button onclick="switchForm('purchase')">ğŸ“¦ æ¡è³¼è¡¨å–®</button>
      <button onclick="switchForm('query')">ğŸ“¥ é€²è²¨æŸ¥è©¢</button>
    </div>
    <div class="main">
      <div id="purchaseForm">
      <form>
        <div class="section">
          <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
            <h3 style="margin: 0;">ğŸšš æ¡è³¼å–®ä¸»è³‡æ–™</h3>
              
              <select id="company_select" onchange="updateCompanyInfo()" style="padding: 4px 6px; max-width: 250px;">
                <option value="rxtech">ç‘é‘«é›»å­ç§‘æŠ€æœ‰é™å…¬å¸</option>
                <option value="rxindustry">ç‘é‘«æ¬£æ¥­æœ‰é™å…¬å¸</option>
                <option value="ruihong">ç‘é´»é›»å­æœ‰é™å…¬å¸</option>
                <option value="ruihongtech">ç‘å®é›»å­ç§‘æŠ€æœ‰é™å…¬å¸</option>
              </select>
          </div>
          <table>
            <tr>
              <th style="width: 20%;">æ¡è³¼æ—¥æœŸ</th>
              <th style="width: 30%;">å» å•†åç¨±</th>
              <th style="width: 30%;">æ¡è³¼å–®è™Ÿ</th>
              <th style="width: 20%;">å‚™è¨»</th>
            </tr>
            <tr>
              <td><input type="date" id="shipment_date" required></td>
              <td>
                <select id="customer_select" required style="width: 100%;">
                <option value="">è«‹é¸æ“‡å®¢æˆ¶åç¨±</option>
              </select>
              </td>
              <td><input type="text" id="shipment_id" readonly style="background-color: #eee;"></td>
              <td><input type="text" id="shipment_note" placeholder="å‚™è¨»ï¼ˆå¯ç©ºï¼‰"></td>
            </tr>
          </table>
        </div>
        <div>
          <h3>ğŸ“¦ æ¡è³¼æ˜ç´°</h3>
          <table id="detailTable">
            <thead>
              <tr>
                <th style="width: 16%;">å“è™Ÿ</th>
                <th style="width: 28%;">å“å / è¦æ ¼</th>
                <th style="width: 10%;">æ•¸é‡</th>
                <th style="width: 12%;">å–®åƒ¹</th>
                <th style="width: 14%;">å°è¨ˆ</th>
                <th style="width: 15%;">å‚™è¨»</th>
                <th style="width: 5%;">åˆªé™¤</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><select name="item_code" class="item_code_select">
                  <option value="">è«‹é¸æ“‡å“è™Ÿ</option>
                </select>
              </td>
                <td><input type="text" name="item_name"></td>
                <td><input type="number" name="qty" oninput="calcSubtotal(this)"></td>
                <td><div class="input-wrapper"><input type="number" name="price" step="0.001" oninput="calcSubtotal(this)"></div></td>
                <td><span class="subtotal-cell">$0.00</span></td>
                <td><input type="text" name="note"></td>
                <td><button type="button" class="delete-btn" onclick="deleteRow(this)">âœ–</button></td>
              </tr>
            </tbody>
          </table>
          <button type="button" class="add-btn" onclick="addRow()">â• æ–°å¢ä¸€ç­†</button>
        </div>
        <button id="submitBtn" class="submit-btn" type="submit">é€å‡ºæ¡è³¼ç´€éŒ„</button> 
      </form>
      </div>
      <div id="queryForm" style="display: none;">
        <div class="section">
          <h3>ğŸ” é€²è²¨æŸ¥è©¢</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 12px;">
              <input type="date" id="startDate" style="flex: 1; min-width: 150px; padding: 10px;" />
              <input type="date" id="endDate" style="flex: 1; min-width: 150px; padding: 10px;" />
              <input id="searchInput" type="text" placeholder="è«‹è¼¸å…¥å» å•†åç¨±ã€å“åæˆ–å–®è™Ÿ" style="flex: 2; min-width: 200px; padding: 10px;" />
              <button onclick="searchPurchases()" style="padding: 10px 16px; font-weight: bold; white-space: nowarp;">ğŸ” æŸ¥è©¢</button>
            </div>
        </div>
        <div class="section" id="searchResult">
          <!-- æŸ¥è©¢çµæœæœƒæ”¾é€™è£¡ -->
        </div>
      </div>
    </div>
  </div>
  <script>
    let supplierInfoMap = {}; //å„²å­˜ä¾›æ‡‰å•†è³‡æ–™çš„å…¨åŸŸè®Šæ•¸
    //æ›´æ–°å…¬å¸æŠ¬é ­
    const companyMap = {
      rxtech: {
        name: "ç‘é‘«é›»å­ç§‘æŠ€æœ‰é™å…¬å¸",
        taxId: "53035197"
      },
      rxindustry: {
        name: "ç‘é‘«æ¬£æ¥­æœ‰é™å…¬å¸",
        taxId: "82888075"
      },
      ruihong: {
        name: "ç‘é´»é›»å­æœ‰é™å…¬å¸",
        taxId: "82878750"
      },
      ruihongtech: {
        name: "ç‘å®é›»å­ç§‘æŠ€æœ‰é™å…¬å¸",
        taxId: "24670248"
      }
    };
    function updateCompanyInfo() {
      const selected = document.getElementById("company_select").value;
      const company = companyMap[selected] || companyMap.rxtech;
      document.getElementById("print_company_name").textContent = company.name;
      document.getElementById("print_tax_id").textContent = company.taxId;
    }

    window.onload = function () {
      const today = new Date();
      document.getElementById('shipment_date').value = today.toISOString().substr(0, 10);
      //é è¨­æŸ¥è©¢èµ·è¿„æ—¥æœŸ
      const oneMonthAgo = new Date(today);
      oneMonthAgo.setMonth(today.getMonth() -1);
      document.getElementById("startDate").value = oneMonthAgo.toISOString().split("T")[0];
      document.getElementById("endDate").value = today.toISOString().split("T")[0]; 
      //é è¨­æŸ¥è©¢èµ·è¿„æ—¥æœŸ
      loadShipmentId();
      $('#customer_select').select2({
        placeholder: "è«‹é¸æ“‡å®¢æˆ¶åç¨±",
        width: '100%'
      });
      // è¼‰å…¥å®¢æˆ¶(ä¾›æ‡‰å•†)è³‡æ–™
      fetch("https://script.google.com/macros/s/AKfycbz798484Bc7Lh4AdFVlC8pLWJNULmW952Sr8nCd3JQYmfy6aQrsRfqq5OZVVzx4A8ZM/exec?type=supplier")
        .then(res => res.json())
        .then(data => {
          if (data.status === "success") {
            const customers = data.suppliers || [];

            const select = document.getElementById("customer_select");

            customers.forEach(c => {
              const opt = document.createElement("option");
              opt.value = c.id; //å®¢æˆ¶ç·¨è™Ÿ
              opt.textContent = c.name;  //å®¢æˆ¶åç¨±
              select.appendChild(opt);

              supplierInfoMap[c.id] = {
                name: c.name,
                fax: c.fax || "",
                tel: c.tel || "",
                contact: c.contact || "",
                companyKey: c.companyKey || "" //åŠ å…¥é è¨­å…¬å¸æŠ¬é ­
              };
            });

            $('#customer_select').select2({
              placeholder: 'è«‹é¸æ“‡å®¢æˆ¶åç¨±',
              width: '100%'
            });

            document.getElementById("loadingOverlay").style.display = "none";

          //ç•¶é¸æ“‡å» å•†æ™‚ï¼Œè¼‰å…¥è©²å» å•†çš„å‡ºè²¨è³‡æ–™
           $('#customer_select').on('select2:select', function (e) {
            const companyNameTokey = { "ç‘é‘«é›»å­ç§‘æŠ€æœ‰é™å…¬å¸": "rxtech", "ç‘é‘«æ¬£æ¥­æœ‰é™å…¬å¸": "rxindustry", "ç‘é´»é›»å­æœ‰é™å…¬å¸": "ruihong",  "ç‘å®é›»å­ç§‘æŠ€æœ‰é™å…¬å¸": "ruihongtech" }; //å°‡ google sheetçš„æŠ¬é ­(ä¸­æ–‡)è½‰æˆ code
            const vendorCode = e.params.data.id;
            const vendorInfo = supplierInfoMap[vendorCode]; //å…¬å¸æŠ¬é ­çš„è³‡è¨Š
            const itemCodeSelect = document.querySelector('select[name="item_code"]');
            if (vendorInfo && vendorInfo.companyKey) {
              const companyKey = companyNameTokey[vendorInfo.companyKey]; //å°‡ä¸­æ–‡æŠ¬é ­è½‰ç‚º code
              if (companyKey){
                document.getElementById("company_select").value = companyKey;
                updateCompanyInfo();
              }
            }
            
            $(itemCodeSelect).empty();  //å…ˆæ¸…ç©ºèˆŠçš„
            const loadingOption = new Option("è¼‰å…¥ä¸­...","",true,true);
            itemCodeSelect.appendChild(loadingOption);
            $(itemCodeSelect).select2({
              placeholder: "è¼‰å…¥ä¸­...",
              width: "100%"
            });

            fetch("https://script.google.com/macros/s/AKfycbz798484Bc7Lh4AdFVlC8pLWJNULmW952Sr8nCd3JQYmfy6aQrsRfqq5OZVVzx4A8ZM/exec?type=item&vendor=" + vendorCode)
              .then(res => res.json())
              .then(data => {
                itemCodeSelect.innerHTML = '<option value="">è«‹é¸æ“‡å“è™Ÿ</option>'; //æ¸…ç©ºåŸæœ¬å…§å®¹

                if (data.status === "success" && Array.isArray(data.data)) {
                   data.data.forEach(item => {
                    const opt2 = document.createElement("option");
                    opt2.value = item.itemCode;
                    opt2.textContent = item.itemCode;
                    opt2.dataset.name = item.itemName;
                    opt2.dataset.price = item.price;
                    opt2.dataset.note = item.note;
                    itemCodeSelect.appendChild(opt2);
                   });
                  }
                  //ç„¡è«–æ˜¯å¦æœ‰è³‡æ–™ï¼Œéƒ½åˆå§‹åŒ–å“è™Ÿ Select 2
                   $(itemCodeSelect).select2({
                    placeholder: 'è«‹é¸æ“‡å“è™Ÿ',
                    width: '100%',
                    tags: true, //å¯è‡ªè¨‚è¼¸å…¥
                    createTag: function (params) {
                      return {
                        id: params.term,
                        text: params.term,
                        newOption: true
                      };
                    },
                    templateResult: function (data) {
                      if (data.newOption) {
                        return $('<span><strong>â• æ–°å“è™Ÿï¼š</strong> ' + data.text + '</span>');
                      }
                      return data.text;
                    }
                   }).on('select2:select',function (e) {
                    const selected = e.params.data.element;
                    const itemName = selected.dataset.name || "";
                    const price = selected.dataset.price || "";
                    const note = selected.dataset.note || "";

                    const row = itemCodeSelect.closest("tr");
                    row.querySelector('input[name="item_name"]').value = itemName;
                    row.querySelector('input[name="price"]').value = price;
                    row.querySelector('input[name="note"]').value = note;
                   });
              });
          });   
        }
      });
    };
  function calcSubtotal(input) {
    const row = input.closest("tr");
    const qty = parseFloat(row.querySelector('input[name="qty"]').value) || 0;
    const price = parseFloat(row.querySelector('input[name="price"]').value) || 0;
    const subtotal =qty * price;

    const subtotalCell = row.querySelector(".subtotal-cell");
    if (subtotalCell) {
      subtotalCell.textContent = `$${subtotal.toFixed(2)}`;
    }
  }
  //æ–°å¢ä¸€ç­†çš„å‡½æ•¸
  function addRow() {
    const tbody = document.querySelector("#detailTable tbody");
    const firstRow = tbody.rows[0];
    const firstSelect = firstRow.querySelector('select[name="item_code"]'); //å…ˆè§£é™¤ç¬¬ä¸€åˆ—çš„ select2ç¶å®š
    if (firstSelect) $(firstSelect).select2('destroy'); //é™¤æ‰èˆŠçš„å¤–æ®¼ DOM
    const newRow = firstRow.cloneNode(true); //ç”¢ç”Ÿæ–°åˆ—
    //æ¸…ç©º input æ¬„ä½èˆ‡å°è¨ˆ
    newRow.querySelectorAll("input").forEach(input => input.value = "");
    const subtotalSpan = newRow.querySelector(".subtotal-cell");
    if (subtotalSpan) subtotalSpan.textContent = "$0.00";
    //è™•ç†å“è™Ÿæ¬„ä½ï¼Œæ¸…é™¤åŸæœ¬select2 éºç•™çš„ DOM çµæ§‹
    const oldSelect = newRow.querySelector('select[name="item_code"]');
    const newSelect = document.createElement("select");
    newSelect.name = "item_code";
    newSelect.className = "item_code_select";
    newSelect.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';
    oldSelect.replaceWith(newSelect);

    tbody.appendChild(newRow); //æ”¾å…¥æ–°row
    //æŠŠåŸæœ¬ç¬¬ä¸€åˆ—çš„ select2 è£œå›ä¾†
    if (firstSelect) {
      $(firstSelect).select2({
        placeholder: 'è«‹é¸æ“‡å“è™Ÿ',
        width: '100%',
        tags: true,
        createTag: function (params) {
          return { id: params.term, text: params.term, newOption: true };
        },
        templateResult: function (data) {
          if (data.newOption) {
            return $('<span><strong>â• æ–°å“è™Ÿï¼š</strong> ' + data.text + '</span>');
          }
          return data.text;
        }
      });
    }   
    const vendorCode = document.getElementById("customer_select").value; //å–å¾—ç›®å‰é¸å–çš„å®¢æˆ¶ç·¨è™Ÿ
    if (!vendorCode) return; //è‹¥å°šæœªé¸æ“‡å®¢æˆ¶ï¼Œå°±ä¸è¼‰å…¥
    //å‘¼å« APIå–å¾—å“è™Ÿè³‡æ–™
    fetch("https://script.google.com/macros/s/AKfycbz798484Bc7Lh4AdFVlC8pLWJNULmW952Sr8nCd3JQYmfy6aQrsRfqq5OZVVzx4A8ZM/exec?type=item&vendor=" + vendorCode)
      .then(res => res.json())
      .then(data => {
        newSelect.innerHTML = '<option value="">è«‹é¸æ“‡å“è™Ÿ</option>';
        if (data.status === "success" && Array.isArray(data.data)) {
          data.data.forEach(item => {
            const opt3 = document.createElement("option");
            opt3.value = item.itemCode;
            opt3.textContent = item.itemCode;
            opt3.dataset.name = item.itemName;
            opt3.dataset.price = item.price;
            opt3.dataset.note = item.note;
            newSelect.appendChild(opt3);
          });
        }
        //åˆå§‹åŒ–å“è™Ÿ select2 åŠŸèƒ½
        $(newSelect).select2({
          placeholder: 'è«‹é¸æ“‡å“è™Ÿ',
          width: '100%',
          tags: true,
          createTag: function (params) {
            return {
              id: params.term,
              text: params.term,
              newOption: true
            };
          },
          templateResult: function (data) {
            if (data.newOption) {
              return $('<span><strong>â• æ–°å“è™Ÿï¼š</strong> ' + data.text + '</span>');
            }
            return data.text;
          }
        }).on('select2:select', function (e) {
          const selected = e.params.data.element;
          const itemName = selected?.dataset.name || "";
          const price = selected?.dataset.price || "";
          const note = selected?.dataset.note || "";
          const row = newSelect.closest("tr");
          row.querySelector('input[name="item_name"]').value = itemName;
          row.querySelector('input[name="price"]').value = price;
          row.querySelector('input[name="note"]').value = note;
        });
      });
    }


  function deleteRow(button) {
    const row = button.parentElement.parentElement;
    const tbody = row.parentElement;
    if (tbody.rows.length > 1) {
      tbody.removeChild(row);
    } else {
      alert("âš ï¸ è‡³å°‘è¦ä¿ç•™ä¸€ç­†æ˜ç´°");
    }
  }
  /*é€å‡ºå‡ºè²¨è³‡æ–™åˆ°google sheet*/
  document.querySelector("form").addEventListener("submit", function (e) {
  e.preventDefault();
  
  const rows = document.querySelectorAll("#detailTable tbody tr");
  let validCount = 0;

  rows.forEach(row => {
      const item_code = row.querySelector('select[name="item_code"]').value.trim();
      const item_name = row.querySelector('input[name="item_name"]').value.trim();
      if (item_name && item_code) validCount++;
  });
  if (!confirm(`âš ï¸ å‡ºè²¨é …ç›®å…± ${validCount} é …ï¼Œç¢ºèªé€å‡ºï¼Ÿ`)) {
    return;
  }

  const shipment_date = document.getElementById("shipment_date").value;
  const vendor_name = document.getElementById("customer_select").selectedOptions[0].textContent;
  const vendor_code = document.getElementById("customer_select").value; //å–å¾—å» å•†selecté¸å–®çš„ value(å³å®¢æˆ¶ç·¨è™Ÿ)
  const shipment_id = document.getElementById("shipment_id").value;
  const shipment_note = document.getElementById("shipment_note").value;
  
  const records = [];

  rows.forEach(row => {
    const item_code = row.querySelector('select[name="item_code"]').value; 
    const item_name = row.querySelector('input[name="item_name"]').value;
    const qty = row.querySelector('input[name="qty"]').value;
    const price = row.querySelector('input[name="price"]').value;
    const subtotal = row.querySelector('.subtotal-cell')?.textContent.replace('$', '').trim() || "0";
    const note = row.querySelector('input[name="note"]').value;

    if (item_name && item_code) {
      records.push({
        shipment_date,
        vendor_name,
        vendor_code,
        shipment_id,
        shipment_note,
        item_name,
        item_code,
        qty,
        price,
        subtotal,
        note
      });
    }
  });

  if (records.length === 0) {
    alert("âš ï¸ è«‹è‡³å°‘å¡«å¯«ä¸€ç­†å‡ºè²¨æ˜ç´°ï¼");
    return;
  }

  const submitBtn = document.getElementById("submitBtn");
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="spinner-small"></span>é€å‡ºä¸­...';

  fetch("https://script.google.com/macros/s/AKfycbwAHSThKWoKxEgQWp2vK5kXOcaf7oByzcSwlf-JRJ_S8GRZ0sdamDCMfQ9CGL3uG_0D/exec", {
    method: "POST",
    mode: "no-cors",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ records })
  })
  .then(() => {
    alert("âœ… æ¡è³¼è³‡æ–™å·²é€å‡ºï¼");
    document.getElementById("detailTable").classList.add("table-sent-success"); //åŠ ä¸Šæ·ºç¶ è‰²èƒŒæ™¯
    submitBtn.disabled = false;
    submitBtn.innerHTML = "é€å‡ºæ¡è³¼ç´€éŒ„";
  })
  .catch((error) => {
    alert("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + error);
    submitBtn.disabled = false;
    submitBtn.innerHTML = "é€å‡ºæ¡è³¼ç´€éŒ„";
  });
});/*é€å‡ºå‡ºè²¨è³‡æ–™åˆ°google sheet*/
//é‡æ–°æ•´ç†åŠŸèƒ½
function resetForm() {
  document.getElementById("detailTable").classList.remove("table-sent-success"); //ç§»é™¤ç¶ è‰²èƒŒæ™¯
  document.getElementById("shipment_note").value = "";
  document.getElementById("shipment_date").value = new Date().toISOString().substr(0, 10);
  document.getElementById("customer_select").selectedIndex = 0;
  $("#customer_select").trigger("change"); //é€šçŸ¥ select2 æ›´æ–°

  const tbody = document.querySelector("#detailTable tbody");
  const firstRow = tbody.rows[0];
  //ç§»é™¤å¤šé¤˜çš„åˆ—
  while (tbody.rows.length > 1) {
    tbody.deleteRow(1);
  }
  firstRow.querySelectorAll("input").forEach(input => input.value = ""); //æ¸…ç©ºç¬¬ä¸€åˆ—æ‰€æœ‰ input å€¼
  //æ¸…ç©ºä¸¦é‡å»ºå“è™Ÿæ¬„ select
  const oldSelect = firstRow.querySelector('select[name="item_code"]');
  const newSelect = document.createElement("select");
  newSelect.name = "item_code";
  newSelect.className = "item_code_select";
  newSelect.innerHTML = '<option value="">è«‹é¸æ“‡å“è™Ÿ</option>';
  $(oldSelect).select2('destroy'); //ç§»é™¤ select2 æ¨£å¼
  oldSelect.replaceWith(newSelect); //æ›¿æ›DOMä¸­åŸæœ¬ select
  loadShipmentId(); //é‡æ–°è¼‰å…¥å‡ºè²¨å–®è™Ÿ
}
//å–å¾—æ–°çš„æ¡è³¼å–®è™Ÿ
function loadShipmentId() {
  fetch("https://script.google.com/macros/s/AKfycbz798484Bc7Lh4AdFVlC8pLWJNULmW952Sr8nCd3JQYmfy6aQrsRfqq5OZVVzx4A8ZM/exec?type=latest_purchase_id")
    .then(res => res.json())
    .then(data => {
      if (data.status === "success") {
        document.getElementById("shipment_id").value = data.shipment_id;
      }else {
        alert("âŒ ç„¡æ³•å–å¾—å‡ºè²¨å–®è™Ÿ");
      }
    })
    .catch(() => {
      alert("âŒ å‡ºè²¨å–®è™Ÿ API è«‹æ±‚å¤±æ•—");
    });
}
//æŒ‰éˆ•åˆ‡æ›(æ¡è³¼ & é€²è²¨)
function switchForm(type) {
  const purchaseForm = document.getElementById("purchaseForm");
  const queryForm = document.getElementById("queryForm");

  if (type === "purchase") {
    purchaseForm.style.display = "block";
    queryForm.style.display = "none";
  } else if (type === "query") {
    purchaseForm.style.display = "none";
    queryForm.style.display = "block";
  }
  //é«˜äº®æŒ‰éˆ•åˆ‡æ›
  const button = document.querySelectorAll(".sidebar button");
  button.forEach(btn => btn.classList.remove("active"));
  if (type === "purchase") {
    button[2].classList.add("active");
  } else {
    button[3].classList.add("active");
  }
}
//æœå°‹é€²è²¨è³‡æ–™
function searchPurchases() {
  const keyword = document.getElementById("searchInput").value.trim().toLowerCase();
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;
  const resultDiv = document.getElementById("searchResult");
  resultDiv.innerHTML = "<div class='spinner' style='margin:10px auto;'></div> è³‡æ–™æŸ¥è©¢ä¸­...";

  let apiUrl = "https://script.google.com/macros/s/AKfycbz798484Bc7Lh4AdFVlC8pLWJNULmW952Sr8nCd3JQYmfy6aQrsRfqq5OZVVzx4A8ZM/exec?type=query_purchase&q=" + encodeURIComponent(keyword);
    
    if (startDate) apiUrl += `&start=${startDate}`;
    if (endDate) apiUrl += `&end=${endDate}`;
    
    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        if (data.status !== "success" || !Array.isArray(data.records)) {
          resultDiv.innerHTML = "âŒ ç„¡æ³•å–å¾—è³‡æ–™";
          return;
        }

        const filtered = data.records.filter(r =>
          (r.vendor || "").toLowerCase().includes(keyword) ||
          (r.name || "").toLowerCase().includes(keyword) ||
          (r.shipment_id || "").toLowerCase().includes(keyword)
        );
        if (filtered.length === 0) {
          resultDiv.innerHTML = "<p>âš ï¸ æ²’æœ‰ç¬¦åˆçš„é€²è²¨ç´€éŒ„</p>";
          return;
        }
      //ç”¢ç”Ÿè¡¨æ ¼
      let html = `
        <table>
            <thead>
              <tr>
                <th>æ—¥æœŸ</th>
                <th>æ¡è³¼å–®è™Ÿ</th>
                <th>å» å•†</th>
                <th>å“å</th>
                <th>æ•¸é‡</th>
                <th>æ˜ç´°å‚™è¨»</th>
                <th>é€²è²¨æ—¥æœŸ</th>
                <th>é€²è²¨ç´€éŒ„</th>
              </tr>
            </thead>
            <tbody>
        `;
        filtered.forEach(r => {
          html += `
            <tr>
              <td>${formatToLocalDate(r.date)}</td>
              <td>${r.shipment_id || ""}</td>
              <td>${r.vendor || ""}</td>
              <td>${r.name || ""}</td>
              <td>${r.qty || ""}</td>
              <td>${r.detailNote || ""}</td>
              <td><input type="text" value="${formatToLocalDate(r.arrivalDate || '')}" data-index="${r.row}" data-vendor="${r.vendorCode}" class="arrival-date-input"></td>
              <td><input type="text" value="${r.arrivalNote || ''}" data-index="${r.row}" data-vendor="${r.vendorCode}" class="arrival-note-input"></td>
            </tr>
          `;
        });
        html += "</tbody></tbody>";
        html += `<button onclick="submitArrivalUpdates()" class="submit-btn" style="margin-top: 20px;">âœ… æ›´æ–°é€²è²¨ç´€éŒ„</button>`
        resultDiv.innerHTML = html;
    })
    .catch(err => {
      resultDiv.innerHTML = "âŒ æŸ¥è©¢å¤±æ•—ï¼š" + err;
    });
}

//æŠŠæœå°‹çš„æ™‚é–“è½‰æ›æˆå°ç£æ™‚å€
function formatToLocalDate(dateString) {
  if (!dateString) return ""; //è‹¥æ˜¯ç©ºçš„ç›´æ¥å›å‚³ç©ºå­—ä¸²
  const d = new Date(dateString);
  if (isNaN(d)) return ""; //ç„¡æ³•è§£æç‚ºæ—¥æœŸçš„è³‡æ–™ä¹Ÿå›ç©ºå­—ä¸²
  d.setHours(d.getHours() + 8);
  return d.toISOString().split("T")[0];
}
//æ›´æ–°é€²è²¨è³‡è¨Š(æŒ‰éˆ•)
function submitArrivalUpdates() {
  const updates = [];
  const arrivalDateInputs = document.querySelectorAll('.arrival-date-input');
  const arrivalNoteInputs = document.querySelectorAll('.arrival-note-input');

  arrivalDateInputs.forEach((input, i) => {
    const date = input.value.trim();
    const note = arrivalNoteInputs[i].value.trim();
    const index = input.dataset.index;
    const vendor = input.dataset.vendor;

    if (index && vendor) {
      updates.push({ index, vendor, arrivalDate: date, arrivalNote: note });
    }
  });
  if (updates.length === 0) {
    alert("â— æ²’æœ‰å¯æ›´æ–°çš„è³‡æ–™");
    return;
  }
  if (!confirm(`ğŸ“ ç¢ºèªè¦æ›´æ–°é€²è²¨è³‡æ–™å—ï¼Ÿ`)) return;
  const updateBtn = document.querySelector('#searchResult Button');
  updateBtn.disabled = true;
  updateBtn.innerHTML = '<span class="spinner-small"></span>æ›´æ–°ä¸­...';

  fetch("https://script.google.com/macros/s/AKfycbwAHSThKWoKxEgQWp2vK5kXOcaf7oByzcSwlf-JRJ_S8GRZ0sdamDCMfQ9CGL3uG_0D/exec", {
    method: "POST",
    mode: "no-cors", //é€™æœƒå½±éŸ¿æœ¬æ©Ÿæ˜¯å¦å¯æ¸¬è©¦
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ type: "update_arrival", updates })
  }).then(() => {
    alert("âœ… æˆåŠŸæ›´æ–°é€²è²¨è³‡æ–™ï¼");
    updateBtn.disabled = false;
    updateBtn.innerHTML = "âœ… æ›´æ–°é€²è²¨ç´€éŒ„";
  }).catch((err) => {
    alert("âŒ æ›´æ–°å¤±æ•—ï¼š" + err);
    updateBtn.disabled = false;
    updateBtn.innerHTML = "âœ… æ›´æ–°é€²è²¨ç´€éŒ„";
  });
}


//åˆ—å°å‡ºè²¨å–®
function printPurchaseOrder() {
  const rows = document.querySelectorAll('#detailTable tbody tr');
  if (rows.length === 0) {
    alert("âŒ æ²’æœ‰å¯åˆ—å°çš„æ¡è³¼é …ç›®ï¼");
    return;
  }

  const printTableBody = document.getElementById("print_table_body");
  printTableBody.innerHTML = "";

  let total = 0;
  let index = 1;

  rows.forEach(row => {
    const itemCode = row.querySelector('select[name="item_code"]').value.trim();
    const itemName = row.querySelector('input[name="item_name"]').value.trim();
    const qty = parseFloat(row.querySelector('input[name="qty"]').value.trim()) || 0;
    const unitPrice = parseFloat(row.querySelector('input[name="price"]').value.trim()) || 0;
    const remark = row.querySelector('input[name="note"]').value.trim();
    const subtotal = qty * unitPrice;

    if (!itemCode && !itemName) return; //å¦‚æœå“è™Ÿ & å“åéƒ½æ²’å¯«ï¼Œä¸åˆ—å°

    total += subtotal;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="text-align:center;">${index++}</td>
      <td>${itemName}</td>
      <td style="text-align:right;">${qty}</td>
      <td style="text-align:right;">$${unitPrice.toFixed(2)}</td>
      <td style="text-align:right;">$${subtotal.toFixed(2)}</td>
      <td style="text-align:center;">${remark}</td>
    `;
    printTableBody.appendChild(tr);
  });
  
  if (index === 1) {
    alert("âš ï¸ è«‹è‡³å°‘è¼¸å…¥ä¸€é …è¦åˆ—å°çš„è³‡æ–™ï¼");
    return;
  }
  //è¨­å®šæ¨™é ­è³‡è¨Š
  updateCompanyInfo();
  const today = new Date();
  const todayStr = today.toISOString().slice(0,10);
  const vendorCode = document.getElementById("customer_select").value;
  const vendorData = supplierInfoMap[vendorCode] || {};

  document.getElementById("print_vendor_name").textContent = vendorData.name || "";
  document.getElementById("print_vendor_fax").textContent = vendorData.fax || "";
  document.getElementById("print_vendor_tel").textContent = vendorData.tel || "";
  document.getElementById("print_vendor_contact").textContent = vendorData.contact || "";
  document.getElementById("print_order_id").textContent = document.getElementById("shipment_id").value || "";
  document.getElementById("print_shipment_note").textContent = document.getElementById("shipment_note").value || "";

  const dueStr = new Date(today.setDate(today.getDate() + 7 )).toISOString().slice(0,10);
  
  document.getElementById("print_date").textContent = todayStr;
  document.getElementById("print_due_date").textContent = dueStr;
  document.getElementById("print_total").textContent = `$${total.toFixed(2)}`;

  //é¡¯ç¤ºåˆ—å°å€åŸŸ
  const printContent = document.getElementById("printSection").innerHTML;
  const printWindow = window.open("","_blank","width=850,height=1200");
  printWindow.document.write(`<html><head><title>æ¡è³¼å–®</title></head><body>${printContent}</body></html>`);
  printWindow.document.close();
  printWindow.print();
}

  </script>

  <div id="printSection" style="display: none;">
  <div style="width: 794px; margin: auto; font-family: 'PMingLiU', 'æ¨™æ¥·é«”', serif; font-size: 18px; color: #000; position: relative; height: 1120px;">
    <h2 id="print_company_name" style="text-align: center;">ç‘é‘«é›»å­ç§‘æŠ€æœ‰é™å…¬å¸</h2>
    <p style="text-align: center;">å°å—å¸‚é—œå»Ÿå€ç”°ä¸­é‡Œå—é›„å—è·¯531è™Ÿ<br>é›»è©±ï¼š06-5551667 å‚³çœŸï¼š06-5552301<br>E-mail: a065551667@yahoo.com.tw</p>
    <hr>
    <h3 style="text-align: center;">æ¡è³¼å–®</h3>
    <table style="width: 100%; margin-top: 12px;">
      <p>å» å•†åç¨±ï¼š<span id="print_vendor_name"></span></p>
      <p>å‚³çœŸï¼š<span id="print_vendor_fax"></span></p>
      <p>é›»è©±ï¼š<span id="print_vendor_tel"></span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; è¯çµ¡äººï¼š<span id="print_vendor_contact"></span></p>
    </table>
   
    <p>æ—¥æœŸï¼š<span id="print_date"></span></p>
    <p>è¨‚å–®è™Ÿç¢¼ï¼š<span id="print_order_id"></span></p>

    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;" border="1">
      <thead>
        <tr style="background:#eee; text-align: center;">
          <th>åº</th>
          <th>å“å/è¦æ ¼/é¡è‰²</th>
          <th>æ•¸é‡</th>
          <th>å–®åƒ¹</th>
          <th>ç¸½é‡‘é¡</th>
          <th>å‚™è¨»</th>
        </tr>
      </thead>
      <tbody id="print_table_body"></tbody>
    </table>
    
    <p style="text-align: right;">åˆè¨ˆï¼š<span id="print_total"></span></p>
    
    <p>å» å•†äº¤æœŸï¼š<span id="print_due_date"></span> å‰</p>
    <p>å‚™è¨»ï¼š<span id="print_shipment_note"></span></p>
    <p>å¦‚ç„¡å›è¦†ï¼Œè¦–åŒå¯å¦‚æœŸäº¤è²¨</p>

    <table style="position: absolute; bottom: 0; width: 100%; border-top: 1px dashed #ccc; padding-top: 12px;">
      <tr>
        <td style="width: 33%;">é€²è²¨æª¢é©—ä¾æ“šï¼š</td>
        <td style="width: 33%;">æŠ½é©—æ°´æº–ï¼š</td>
        <td style="width: 34%;"></td>
      </tr>
      <tr><td colspan="3" style="padding-top: 10px;">äº¤è²¨åœ°é»ï¼šç‘é‘«</td></tr>
      <tr><td colspan="3">åŒ…è£æ–¹å¼ï¼š</td></tr>
      <tr><td colspan="3">çµ±ç·¨ï¼š<span id="print_tax_id">53035197</span></td></tr>
      <tr>
        <td style="padding-top: 30px; text-align: left;">å» å•†ç¢ºèªç°½å›ï¼š</td>
        <td style="padding-top: 30px; text-align: center;">æ ¸å‡†ï¼š</td>
        <td style="padding-top: 30px; text-align: right; padding-right: 100px;">è£½è¡¨ï¼š</td>
      </tr>
    </table>
  </div>
  </div>
</body>
</html>